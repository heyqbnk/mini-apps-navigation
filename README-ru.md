[npm-badge]: https://img.shields.io/npm/v/@mini-apps/navigation.svg
[npm-link]: https://npmjs.com/package/@mini-apps/navigation

[<img width="134" src="https://vk.com/images/apps/mini_apps/vk_mini_apps_logo.svg">](https://vk.com/services)

# Navigation [![NPM][npm-badge]][npm-link]

Документация: [RU](https://github.com/wolframdeus/mini-apps-navigation/blob/master/README-ru.md) / [EN](https://github.com/wolframdeus/mini-apps-navigation/blob/master/README.md)

Библиотека для организации навигации в приложениях на базе Mini Apps

## Установка
```bash
yarn add @mini-apps/navigation
```
или
```bash
npm i @mini-apps/navigation
``` 

## Описание

Эта библиотека была разработана с ориентацией на мобильные приложения. По этой
причине, основными терминами, которые используются в ней являются
`segue` (переход), `view`, `modal`, `popup` и так далее. Не стоит ожидать
каких-либо терминов из мира Web в контексте `Navigator`. В этой библиотеке
я попробовал воссоздать логику, которая используется в реальных нативных
приложениях и ожидаю содействия других разработчиков.

## Глоссарий

### Локация
`Локация` это один из самых часто применяемых терминов в этом проекте. Он
описывается такими полями как `view`, `modal`, `popup`, `params` и `modifiers`.
Свойства `modal` и `popup` необязательны, чего нельзя сказать о `view`. Обычно,
не может быть ситуации когда текущее вью неизвестно, мы всегда должны что-либо
отображать, именно по этой причине `view` обязательно. `params` представляет
собой кастомный набор данных. `modifiers` - список примененных к локации 
модификаторов (см. далее).

### Техническая локация

`Техническая локация` содержит лишь модификаторы и используется с целью
выполнения какого-то особенного алгоритма в приложении. Например, техническая
локация могла быть локацией с модификатором `root`. Он добавляется навигатором
по умолчанию для того чтобы обнаружить первую локацию в стеке. Также, существует
модификатор `skip`, который вынуждает навигатор "проскользить" по стеку до
момента встречи локации без этого модификатора.

### Модификация

`Модификация` это опция применяемая к локации (которая является URI в веб).
Эта библиотека резервирует небольшой список модификаторов, каждый из которых 
заставляет навигатор вести себя особым образом.

| Название | Поведение |
| --- | --- |
| `root` | Помечает текущую локацию как первую локацию в стеке. Не может быть заменена или добавлена в стек |
| `skip` | Заставляет навигатор "проскальзывать" по стеку локаций до момента встречи локации без этого модификатора. Является в каком-то роде пробелом в истории, который необходимо перескочить |
| `replace` | Заставляет навигатор заменить текущую локацию |
| `back` | Заставляет навигатор идти назад по стеку |

## Классы

### Navigator
`Navigator` представляет собой ядро навигации. Важно понимать,
что этот класс не имеет отношения к какой-либо среде. Имеется ввиду, что
это лишь ядро и по этой причине, оно не работает с чем-то вроде `window.history`
само по себе. Он ожидает, что кто-то это будет делать за него. `Navigator`
содержит лишь сложную и основную логику связанную с навигацией.

Если вы разрабатываете приложения для работы с историей браузера, возможно,
вам необходим [BrowserNavigator](#BrowserNavigator).

[Определение](https://github.com/wolframdeus/mini-apps-navigation/blob/master/src/Navigator/Navigator.ts#L22)

#### Использование
##### Создание инстанса

```typescript
import {Navigator} from '@mini-apps/navigation';

const navigator = new Navigator();
```

##### Инициализация
Инициализация полезна в тот момент, когда стек локаций известен. Поэтому,
вы можете где-либо ее хранить и затем передать в навигатор

```typescript
const locationIndex = getLastLocationIndexFromCache();
const locationsStack = getLastLocationsStackFromCache();

navigator.init(locationIndex, locationsStack);
```

##### Добавление и удаление слушателей событий
```typescript
// Создание слушателя
const listener = location => {
  console.log('New location:', location);
};

// Добавление слушателя на изменения локации. Важно понимать, что этот слушатель
// будет вызван только после вызова специальных методов, таких как pushLocation, 
// replaceLocation, processLocation и go
navigator.on('location-changed', listener);

// Вызовет слушатель
navigator.processLocation({modifiers: ['back']});

// НЕ вызовет слушатель, т.к. передан параметр silent
navigator.processLocation({modifiers: ['back']}, {silent: true});

// Удаление слушателя
navigator.off('location-changed', listener);
```

##### Изменение локации
```typescript
// Добавление новой локации
navigator.processLocation({view: 'onboarding'});

// Открытие одноразового alert
navigator.processLocation({
  view: 'onboarding',
  popup: 'my-alert',
  modifiers: ['shadow'],
});

// Замена текущей локации
navigator.replaceLocation({view: 'main'});

// Возврат на онбординг
navigator.go(-1);

// Вперед к онбордингу
navigator.go(1);
```

### BrowserNavigator

`BrowserNavigator` адаптирован для браузера и работает с `window.history`.
Он расширяет некоторые методы `Navigator`, такие как `on`, `off` и `go`, 
функционалом, который, преимущественно, связан с взаимодействием с историей
браузера.

Так же, он переопределяет такие функции как `window.history.pushState` и 
`window.history.replaceState` и в итоге, каждый элемент истории имеет
стабильное состояние (state), которое содержит текущий индекс локации, а также
историю локаций.

#### Использование
##### Создание инстанса
```typescript
import {BrowserNavigator} from '@mini-apps/navigation';

const navigator = new BrowserNavigator();
```

##### Инициализация
Когда `window.history` становится доступным, необходимо инициализировать
навигатор чтобы заставить его переопределить `window.history.pushState` и 
`window.history.replaceState`, а также добавить слушатель события popstate.

```typescript
navigator.init();
```

Отмена переопределений и удаление слушателя:

```typescript
navigator.unmount();
```

##### Начальное состояние навигатора

Для того, чтобы иницилизировать навигатор было проще, существует функция
`extractBrowserNavigatorSettings`, которая вернет начальные данные для 
навигатора в случае если это возможно.

```typescript
import {extractBrowserNavigatorSettings} from '@mini-apps/navigation';

// Извлекаем настройки навигатора
const navigatorSettings = extractBrowserNavigatorSettings();

// Инициализируем с полученными настройками
navigator.init(navigatorSettings ? navigatorSettings : undefined);
```

В случае, если в `init` первый параметр не передан, навигатор смотрит
на длину истории и в случае, когда она равна 1, навигатор понимает, что
ранее он не привязывался к истории браузера и как следствие, заменяет
текущую локацию на локацию с модификатором `root` который является индикатором
первой локации в стеке.

##### Слушатель для `popstate`
Когда `mount()` вызывается, навигатор добавляет свой собственный слушатель,
который наблюдает за изменения текущего маршрута и автоматически обновляет
текущую локацию. Логика достаточно проста - он пытается извлечь информацию 
навигатора из состояния (поле `state`) элемента истории и корректно обновляет
навигатор. В случае неудачи, он распознает локацию как новую, пытается
спарсить её и передать навигатору. Если и парсинг оказывается неудачным,
событие добавление нового элемента в историю отклоняется и выбрасывается ошибка.
